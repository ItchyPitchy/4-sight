function t(t,e,s,i){Object.defineProperty(t,e,{get:s,set:i,enumerable:!0,configurable:!0})}function e(t){return t&&t.__esModule?t.default:t}var s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},i={},n={},o=s.parcelRequire2c60;null==o&&((o=function(t){if(t in i)return i[t].exports;if(t in n){var e=n[t];delete n[t];var s={id:t,exports:{}};return i[t]=s,e.call(s.exports,s,s.exports),s.exports}var o=Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(t,e){n[t]=e},s.parcelRequire2c60=o),o.register("dRo73",function(e,s){t(e.exports,"register",()=>i,t=>i=t),t(e.exports,"resolve",()=>n,t=>n=t);var i,n,o={};i=function(t){for(var e=Object.keys(t),s=0;s<e.length;s++)o[e[s]]=t[e[s]]},n=function(t){var e=o[t];if(null==e)throw Error("Could not resolve bundle with id "+t);return e}}),o("dRo73").register(JSON.parse('{"50T4R":"index.b0a4fd9a.js","aErs1":"player1.23902755.png","5h0UA":"player2.79742113.png","aksZk":"plasmabullet.7878639b.png","eKXLM":"ickybullet.79b0918f.png","kU9W7":"image.6770f270.png"}'));class r{appliesTo(t){return!1}update(t,e,s,i){throw Error("not implemented")}draw(t){}}class a{constructor(){}}class h extends a{constructor(){super()}}class l extends a{constructor(t,e){super(),this.x=t,this.y=e}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(t){return this.x*t.x+this.y*t.y}norm(){return{x:this.x/this.magnitude(),y:this.y/this.magnitude()}}normalize(){let t=this.norm();return new l(t.x,t.y)}}class u extends h{constructor(){super()}}class p extends h{constructor(){super()}}class y extends r{constructor(){super()}appliesTo(t){return t.hasComponent(h)}update(t,e,s){for(let e of t)for(let s of t)if(e!==s&&(e.hasComponent(u)&&s.hasComponent(p)||e.hasComponent(p)&&s.hasComponent(u))){let t=e.hasComponent(u)?e:s.hasComponent(u)?s:null,i=e.hasComponent(p)?e:s.hasComponent(p)?s:null;if(!t||!i)throw Error("Not exactly one point- and one rectangle shaped entity hitbox (should not happen)");let n=this.circleRectangleCollision(t,i);n&&this.resolveCircleRectCollision(t,i)}}// pointRectangleCollision(circleEntity: Entity, rectEntity: Entity) {
//   const cx = circleEntity.position.x; // point position
//   const cy = circleEntity.position.y;
//   const rx = rectEntity.position.x; // rectangle position
//   const ry = rectEntity.position.y;
//   const rw = rectEntity.size.width; // and dimensions
//   const rh = rectEntity.size.height;
//   // is the point inside the rectangle's bounds?
//   if (
//     cx >= rx && // left edge
//     cx <= rx + rw && // right edge
//     cy >= ry && // top edge
//     cy <= ry + rh // bottom edge
//   ) {
//     return true;
//   }
//   return false;
// }
// resolvePointRectangleCollision(pointEntity: Entity, rectEntity: Entity) {
//   const px = pointEntity.position.x; // point position
//   const py = pointEntity.position.y;
//   const rx = rectEntity.position.x; // rectangle position
//   const ry = rectEntity.position.y;
//   const rw = rectEntity.size.width; // and dimensions
//   const rh = rectEntity.size.height;
//   // Expects that point entity has vector but not rectangle entity
//   const leftOffset = px - rx;
//   const rightOffset = rx + rw - px;
//   const topOffset = py - ry;
//   const bottomOffset = ry + rh - py;
//   const pointEntityVector = pointEntity.getComponent(Vector) as Vector;
//   if (pointEntityVector) {
//     if (leftOffset < topOffset && leftOffset < bottomOffset && pointEntityVector.x > 0) {
//       pointEntityVector.x = -pointEntityVector.x
//     } else if (rightOffset < topOffset && rightOffset < bottomOffset && pointEntityVector.x < 0) {
//       pointEntityVector.y = -pointEntityVector.x
//     } else if (topOffset < leftOffset && topOffset < rightOffset && pointEntityVector.y > 0) {
//       pointEntityVector.y = -pointEntityVector.y
//     } else if (bottomOffset < leftOffset && bottomOffset < rightOffset && pointEntityVector.y < 0) {
//       pointEntityVector.y = -pointEntityVector.y
//     }
//   }
// }
circleRectangleCollision(t,e){let s=t.position.x,i=t.position.y,n=e.position.x,o=e.position.y,r=e.size.width,a=e.size.height,h=s,l=i;s<n?h=n:s>n+r&&(h=n+r),i<o?l=o:i>o+a&&(l=o+a);let u=s-h,p=i-l;return Math.sqrt(u*u+p*p)<=t.size.width/2}resolveCircleRectCollision(t,e){let s=t.position.x,i=t.position.y,n=e.position.x,o=e.position.y,r=e.size.width,a=e.size.height,h=s-n,u=n+r-s,p=i-o,y=o+a-i,g=t.getComponent(l);g?h<p&&h<y&&g.x>0?(t.position.x=e.position.x-t.size.width/2,g.x=-g.x):u<p&&u<y&&g.x<0?(t.position.x=e.position.x+e.size.width+t.size.width/2,g.x=-g.x):p<h&&p<u&&g.y>0?(t.position.y=e.position.y-t.size.height/2,g.y=-g.y):y<h&&y<u&&g.y<0&&(t.position.y=e.position.y+e.size.height+t.size.height/2,g.y=-g.y):h<p&&h<y?t.position.x=e.position.x-t.size.width/2:u<p&&u<y?t.position.x=e.position.x+e.size.width+t.size.width/2:p<h&&p<u?t.position.y=e.position.y-t.size.height/2:y<h&&y<u&&(t.position.y=e.position.y+e.size.height+t.size.height/2)}}class g extends r{constructor(){super()}appliesTo(t){return t.hasComponent(l)}update(t,e,s){for(let s of t){let t=s.getComponent(l);s.position.x+=t.x*e,s.position.y+=t.y*e}}}class d{constructor(t,e){this.position=t,this.size=e,this.components=[]}distanceTo(t){return Math.sqrt(Math.pow(this.position.x-t.position.x,2)+Math.pow(this.position.y-t.position.y,2))}getComponent(t){for(let e of this.components)// @ts-ignore
if(e instanceof t)return e}addComponents(...t){for(let e of t)this.components.push(e)}hasComponent(t){for(let e of this.components)// @ts-ignore
if(e instanceof t)return!0;return!1}removeComponent(t){this.components=this.components.filter(e=>e instanceof t)}draw(t){throw Error("Not implemented yet")}}class c extends d{constructor(t,e){super(t,e),this.degrees=0}draw(t){}}var x={};x=new URL(o("dRo73").resolve("aErs1"),import.meta.url).toString();class m extends c{constructor(t,s){super(t,s),this.texture=null;let i=new Image;i.src=/*@__PURE__*/e(x),this.texture=i}draw(t){t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.degrees),this.texture&&t.drawImage(this.texture,-this.size.width/2,-this.size.height/2,this.size.width,this.size.height),t.restore()}}var f={};f=new URL(o("dRo73").resolve("5h0UA"),import.meta.url).toString();class w extends c{constructor(t,s){super(t,s),this.texture=null;let i=new Image;i.src=/*@__PURE__*/e(f),this.texture=i}draw(t){t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.degrees),this.texture&&t.drawImage(this.texture,-this.size.width/2,-this.size.height/2,this.size.width,this.size.height),t.restore()}}class S extends r{constructor(){super(),this.keys=new Set,document.addEventListener("keydown",t=>{switch(t.keyCode){case 87:this.keys.add("w");break;case 65:this.keys.add("a");break;case 83:this.keys.add("s");break;case 68:this.keys.add("d")}}),document.addEventListener("keyup",t=>{switch(t.keyCode){case 87:this.keys.delete("w");break;case 65:this.keys.delete("a");break;case 83:this.keys.delete("s");break;case 68:this.keys.delete("d")}})}appliesTo(t){return t instanceof c}update(t,e,s,i){for(let e of t)"RESULT"===s.levelState?e instanceof m?e.position=s.player1Turn[s.playerTurnCurrentIndex].position:e instanceof w&&(e.position=s.player2Turn[s.playerTurnCurrentIndex].position):("PLAYER_1_TURN"===s.levelState||"PLAYER_2_TURN"===s.levelState)&&(this.keys.has("w")&&(e.position.y-=2),this.keys.has("a")&&(e.position.x-=2),this.keys.has("s")&&(e.position.y+=2),this.keys.has("d")&&(e.position.x+=2))}}class T extends d{constructor(t,e){super(t,{width:2*e,height:2*e}),this.radius=e,this.lifeLength=5}draw(t){}}var C={};C=new URL(o("dRo73").resolve("aksZk"),import.meta.url).toString();class M extends T{constructor(t,s){super(t,s),this.texture=null;let i=new Image;i.src=/*@__PURE__*/e(C),this.texture=i}draw(t){t.save(),this.texture&&t.drawImage(this.texture,this.position.x-this.radius,this.position.y-this.radius,this.size.width,this.size.height),t.restore()}}var P={};P=new URL(o("dRo73").resolve("eKXLM"),import.meta.url).toString();class b extends T{constructor(t,s){super(t,s),this.texture=null;let i=new Image;i.src=/*@__PURE__*/e(P),this.texture=i}draw(t){t.save(),this.texture&&t.drawImage(this.texture,this.position.x-this.radius,this.position.y-this.radius,this.size.width,this.size.height),t.restore()}}class v extends r{constructor(){super(),this.gameWidth=0,this.gameHeight=0,this.startPos=[],this.aimPos=[],this.nearestIntersections=[]}appliesTo(t){return t instanceof d}update(t,e,s,i){this.gameWidth=i.gameWidth,this.gameHeight=i.gameHeight;let n=t.filter(t=>t instanceof c),o=[],r=[],a=[];for(let e of n){let n={x:e.position.x,y:e.position.y},h={x:0,y:0};"RESULT"===s.levelState?e instanceof m?(h.x=n.x+e.size.width/2*Math.cos(this.getDegrees(e.position,s.player1Turn[s.playerTurnCurrentIndex].mousePos)),h.y=n.y+e.size.height/2*Math.sin(this.getDegrees(e.position,s.player1Turn[s.playerTurnCurrentIndex].mousePos)),e.degrees=this.getDegrees(e.position,s.player1Turn[s.playerTurnCurrentIndex].mousePos)+Math.PI/2):e instanceof w&&(h.x=n.x+e.size.width/2*Math.cos(this.getDegrees(e.position,s.player2Turn[s.playerTurnCurrentIndex].mousePos)),h.y=n.y+e.size.height/2*Math.sin(this.getDegrees(e.position,s.player2Turn[s.playerTurnCurrentIndex].mousePos)),e.degrees=this.getDegrees(e.position,s.player2Turn[s.playerTurnCurrentIndex].mousePos)+Math.PI/2):(h.x=n.x+e.size.width/2*Math.cos(this.getDegrees(e.position,i.mousePos)),h.y=n.y+e.size.height/2*Math.sin(this.getDegrees(e.position,i.mousePos)),e.degrees=this.getDegrees(e.position,i.mousePos)+Math.PI/2),r.push(h);let y=new l(0,0);"RESULT"===s.levelState?e instanceof m?s.player1Turn[s.playerTurnCurrentIndex]&&(y.x=s.player1Turn[s.playerTurnCurrentIndex].mousePos.x-e.position.x,y.y=s.player1Turn[s.playerTurnCurrentIndex].mousePos.y-e.position.y):e instanceof w&&s.player2Turn[s.playerTurnCurrentIndex]&&(y.x=s.player2Turn[s.playerTurnCurrentIndex].mousePos.x-e.position.x,y.y=s.player2Turn[s.playerTurnCurrentIndex].mousePos.y-e.position.y):(y.x=i.mousePos.x-e.position.x,y.y=i.mousePos.y-e.position.y);let g=Math.sqrt(Math.pow(y.x,2)+Math.pow(y.y,2)),d={x:y.x/g,y:y.y/g},c={x:d.x*Math.sqrt(Math.pow(i.gameWidth,2)+Math.pow(i.gameHeight,2)),y:d.y*Math.sqrt(Math.pow(i.gameWidth,2)+Math.pow(i.gameHeight,2))},x={x:h.x+c.x,y:h.y+c.y};o.push(x);let f=x.x,S=x.y,T=h.x,C=h.y,P={intersectionX:f,intersectionY:S},v=t.filter(t=>t.hasComponent(p));// points for line (controlled by mouse)
for(let t of v){let e=t.position.x,s=t.position.y,i=t.size.width,n=t.size.height,o=this.lineRect(f,S,T,C,e,s,i,n);// square position
for(let t of o){let e=t.intersectionX-T,s=t.intersectionY-C,i=Math.sqrt(Math.pow(e,2)+Math.pow(s,2)),n=P.intersectionX-T,o=P.intersectionY-C,r=Math.sqrt(Math.pow(n,2)+Math.pow(o,2));i<r&&(P={intersectionX:t.intersectionX,intersectionY:t.intersectionY})}}if(a.push(P),"RESULT"===s.levelState){if(e instanceof m&&!0===s.player1Turn[s.playerTurnCurrentIndex].shoot){let t=new M({x:h.x,y:h.y},20);t.addComponents(new l(1e3*d.x,1e3*d.y),new u),s.entities.push(t)}if(e instanceof w&&!0===s.player2Turn[s.playerTurnCurrentIndex].shoot){let t=new b({x:h.x,y:h.y},20);t.addComponents(new l(1e3*d.x,1e3*d.y),new u),s.entities.push(t)}}else if(i.keys.has("leftClick")){if(e instanceof m&&"PLAYER_1_TURN"===s.levelState){s.player1Turn[s.player1Turn.length-1].shoot=!0;let t=new M({x:h.x,y:h.y},20);t.addComponents(new l(1e3*d.x,1e3*d.y),new u),s.entities.push(t)}else if(e instanceof w&&"PLAYER_2_TURN"===s.levelState){s.player2Turn[s.player2Turn.length-1].shoot=!0;let t=new b({x:h.x,y:h.y},20);t.addComponents(new l(1e3*d.x,1e3*d.y),new u),s.entities.push(t)}i.keys.delete("leftClick")}this.startPos=r,this.aimPos=o,this.nearestIntersections=a}}draw(t){for(let e=0;e<Math.min(this.startPos.length,this.aimPos.length,this.nearestIntersections.length);e++)t.save(),t.fillStyle="orange",t.beginPath(),t.arc(this.startPos[e].x,this.startPos[e].y,5,0,2*Math.PI),t.fill(),// draw the line
t.beginPath(),t.strokeStyle="#00FFFF",t.moveTo(this.startPos[e].x,this.startPos[e].y),t.lineTo(this.nearestIntersections[e].intersectionX,this.nearestIntersections[e].intersectionY),t.stroke(),// draw intersection dot
t.fillStyle="#00FFFF",t.beginPath(),t.arc(this.nearestIntersections[e].intersectionX,this.nearestIntersections[e].intersectionY,5,0,2*Math.PI),t.fill(),t.restore()}lineRect(t,e,s,i,n,o,r,a){// check if the line has hit any of the rectangle's sides
// uses the Line/Line function below
let h=this.lineLine(t,e,s,i,n,o,n,o+a),l=this.lineLine(t,e,s,i,n+r,o,n+r,o+a),u=this.lineLine(t,e,s,i,n,o,n+r,o),p=this.lineLine(t,e,s,i,n,o+a,n+r,o+a),y=[];return h&&y.push(h),l&&y.push(l),u&&y.push(u),p&&y.push(p),y}lineLine(t,e,s,i,n,o,r,a){// calculate the direction of the lines
let h=((r-n)*(e-o)-(a-o)*(t-n))/((a-o)*(s-t)-(r-n)*(i-e)),l=((s-t)*(e-o)-(i-e)*(t-n))/((a-o)*(s-t)-(r-n)*(i-e));return(// if uA and uB are between 0-1, lines are colliding
h>=0&&h<=1&&l>=0&&l<=1?{intersectionX:t+h*(s-t),intersectionY:e+h*(i-e)}:null)}getDegrees(t,e){if(!e)throw Error("No mousePos");if(e.y>t.y){if(e.x>t.x){let s=Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))+Math.PI/2;return s}}if(e.x>t.x){let s=-Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=-Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))-Math.PI/2;return s}}}class R extends r{constructor(){super()}appliesTo(t){return t instanceof c}update(t,e,s,i){let n=t.find(t=>t instanceof c);if(n&&("PLAYER_1_TURN"===s.levelState?s.player1Turn.push({mousePos:i.mousePos,position:{x:n.position.x,y:n.position.y},shoot:!1}):"PLAYER_2_TURN"===s.levelState&&s.player2Turn.push({mousePos:i.mousePos,position:{x:n.position.x,y:n.position.y},shoot:!1})),s.playerTurnCount+=e,s.playerTurnTimer<=s.playerTurnCount){if(0===s.player1Turn.length)s.levelState="PLAYER_1_TURN",i.gameStartCountDown=3,i.gameState="PAUSED",s.playerTurnTimer=5,s.playerTurnCount=0;else if(0===s.player2Turn.length)s.levelState="PLAYER_2_TURN",i.gameStartCountDown=3,i.gameState="PAUSED",s.playerTurnTimer=5,s.playerTurnCount=0;else{// Hacky as shit
let t=Math.min(s.player1Turn.length,s.player2Turn.length);"RESULT"!==s.levelState?(s.player1Turn=s.player1Turn.filter((e,s)=>s<t-1),s.player2Turn=s.player2Turn.filter((e,s)=>s<t-1),s.levelState="RESULT",i.gameStartCountDown=3,i.gameState="PAUSED",s.playerTurnTimer=5,s.playerTurnCount=0):"RESULT"===s.levelState&&s.playerTurnCurrentIndex===t-1&&(s.playerTurnCurrentIndex=0,s.levelState="PLAYER_1_TURN",i.gameStartCountDown=3,i.gameState="PAUSED",s.playerTurnTimer=5,s.playerTurnCount=0,s.player1Turn=[],s.player2Turn=[])}s.buildLevel(i.gameWidth,i.gameHeight)}}}class I extends d{constructor(t,e){super(t,e),this.components=[]}draw(t){// ctx.beginPath();
// ctx.fillStyle = "#FFF";
// ctx.fillRect(
//   this.position.x,
//   this.position.y,
//   this.size.width,
//   this.size.height
// );
// ctx.fill();
// ctx.closePath();
}}class k extends I{constructor(t,e){super(t,e)}draw(t){t.save(),t.beginPath(),t.fillStyle="#000",t.fillRect(this.position.x,this.position.y,this.size.width,this.size.height),t.fill(),t.closePath(),t.restore()}}class E extends a{constructor(){super()}}class z{constructor(t,e){this.x=t,this.y=e}}class L extends z{constructor(t,e){super(t,e),this.x=t,this.y=e}}class U{constructor(t,e,s,i){this.d=0,this.p1=new L(t,e),this.p2=new L(s,i),this.p1.segment=this,this.p2.segment=this}}class _{constructor(t,e,s,i){this.x=t,this.y=e,this.width=s,this.height=i}getCorners(){return{nw:new z(this.x,this.y),sw:new z(this.x,this.y+this.height),ne:new z(this.x+this.width,this.y),se:new z(this.x+this.width,this.y+this.height)}}getCornerSegments(){let{nw:t,sw:e,ne:s,se:i}=this.getCorners();return[new U(t.x,t.y,s.x,s.y),new U(t.x,t.y,e.x,e.y),new U(s.x,s.y,i.x,i.y),new U(e.x,e.y,i.x,i.y)]}}const D=(t,e)=>{let{x:s,y:i}=t,n=.5*(e.p1.x+e.p2.x)-s,o=.5*(e.p1.y+e.p2.y)-i;e.d=n*n+o*o,e.p1.angle=Math.atan2(e.p1.y-i,e.p1.x-s),e.p2.angle=Math.atan2(e.p2.y-i,e.p2.x-s)},H=t=>{let e=t.p2.angle-t.p1.angle;e<=-Math.PI&&(e+=2*Math.PI),e>Math.PI&&(e-=2*Math.PI),t.p1.beginsSegment=e>0,t.p2.beginsSegment=!t.p1.beginsSegment},A=(t,e)=>{for(let s of e)D(t,s),H(s);return e};function N(t,e,s,i){let n=((i.x-s.x)*(t.y-s.y)-(i.y-s.y)*(t.x-s.x))/((i.y-s.y)*(e.x-t.x)-(i.x-s.x)*(e.y-t.y));return new z(t.x+n*(e.x-t.x),t.y+n*(e.y-t.y))}function Y(t,e){return t.angle>e.angle?1:t.angle<e.angle?-1:!t.beginsSegment&&e.beginsSegment?1:t.beginsSegment&&!e.beginsSegment?-1:0}const W=(t,e)=>{let s=(t.p2.x-t.p1.x)*(e.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.x-t.p1.x);return s<0},X=(t,e,s)=>new z(t.x*(1-s)+e.x*s,t.y*(1-s)+e.y*s),q=(t,e,s)=>{let i=W(t,X(e.p1,e.p2,.01)),n=W(t,X(e.p2,e.p1,.01)),o=W(t,s),r=W(e,X(t.p1,t.p2,.01)),a=W(e,X(t.p2,t.p1,.01)),h=W(e,s);return r===a&&a!==h||i===n&&n===o};class F extends r{constructor(){super(),this.room=null,this.lightSource=null,this.blocks=[],this.walls=[],this.visibility=[]}appliesTo(t){return t instanceof k||t.hasComponent(E)}update(t,e,s,i){let n=t.find(t=>t instanceof c),o=t.filter(t=>t instanceof k);if(!n){this.lightSource=null;return}if(!i.mousePos)return;// Setup scene
this.room=new _(0,0,i.gameWidth,i.gameHeight),this.walls=[],this.blocks=o.map(t=>new _(t.position.x,t.position.y,t.size.width,t.size.height));let r={x:n.position.x+n.size.width/2*Math.cos(this.getDegrees(n.position,i.mousePos)),y:n.position.y+n.size.height/2*Math.sin(this.getDegrees(n.position,i.mousePos))};// Test lightsource middle of map
this.lightSource=new z(r.x,r.y);let a=function(t,e,s,i){let n=[];for(let e of t.getCornerSegments())n.push(e);for(let t of e)for(let e of t.getCornerSegments())n.push(e);for(let t of s)n.push(t);let o=[];for(let t of A(i,n))o.push(t.p1,t.p2);return o}(this.room,this.blocks,this.walls,this.lightSource);this.visibility=function(t,e){let s=[],i=[],n=0;e.sort(Y);for(let o=0;o<2;o+=1)for(let r of e){let e=s[0];if(r.beginsSegment){let e=0,i=s[0];for(;i&&q(r.segment,i,t);)e+=1,i=s[e];i?s.splice(e,0,r.segment):s.push(r.segment)}else{let t=s.indexOf(r.segment);t>-1&&s.splice(t,1)}if(e!==s[0]){if(1===o){let s=function(t,e,s,i){let n=new z(t.x+Math.cos(e),t.y+Math.sin(e)),o=new z(0,0),r=new z(0,0);i?(o.x=i.p1.x,o.y=i.p1.y,r.x=i.p2.x,r.y=i.p2.y):(o.x=t.x+200*Math.cos(e),o.y=t.y+200*Math.sin(e),r.x=t.x+200*Math.cos(s),r.y=t.y+200*Math.sin(s));let a=N(o,r,t,n);n.x=t.x+Math.cos(s),n.y=t.y+Math.sin(s);let h=N(o,r,t,n);return[a,h]}(t,n,r.angle,e);i.push(s)}n=r.angle}}return i}(this.lightSource,a)}draw(t){this.lightSource&&this.room&&this.drawVisibilityTriangles(t,"gray",this.lightSource,this.visibility)}drawRectangle(t,e,s){t.save(),t.strokeStyle="blue",t.strokeRect(s.x,s.y,s.width,s.height),t.restore()}drawSegment(t,e,s){t.save(),t.beginPath(),t.strokeStyle="black",t.moveTo(s.p1.x,s.p1.y),t.lineTo(s.p2.x,s.p2.y),t.closePath(),t.stroke(),t.restore()}drawVisibilityTriangles(t,e,s,i){for(let e of(t.save(),t.fillStyle="black",t.fillRect(0,0,this.room.width,this.room.height),t.globalCompositeOperation="source-out",t.beginPath(),i))t.moveTo(s.x,s.y),t.lineTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.clip(),t.fillStyle="transparent",t.fill(),t.restore()}getDegrees(t,e){if(!e)throw Error("No mousePos");if(e.y>t.y){if(e.x>t.x){let s=Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))+Math.PI/2;return s}}if(e.x>t.x){let s=-Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=-Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))-Math.PI/2;return s}}}class O extends r{constructor(t,e){super(),this.gameWidth=t,this.gameHeight=e,this.startPos=null,this.aimPos=null}appliesTo(t){return t instanceof c}update(t,e,s,i){let n=t.find(t=>t instanceof c);n instanceof c&&(this.startPos={x:n.position.x+n.size.width/2*Math.cos(this.getDegrees(n.position,i.mousePos)),y:n.position.y+n.size.height/2*Math.sin(this.getDegrees(n.position,i.mousePos))},this.aimPos=i.mousePos)}draw(t){if(!this.aimPos||!this.startPos)return;t.fillStyle="black",t.fillRect(0,0,this.gameWidth,this.gameHeight),t.save(),t.translate(this.startPos.x,this.startPos.y),t.rotate(this.getDegrees(this.startPos,this.aimPos)+Math.PI/2),t.beginPath(),t.moveTo(0,0),t.lineTo(-Math.max(this.gameWidth,this.gameHeight),-Math.max(this.gameWidth,this.gameHeight)),t.lineTo(Math.max(this.gameWidth,this.gameHeight),-Math.max(this.gameWidth,this.gameHeight)),t.clip();// draw background
let e=t.createLinearGradient(0,-800,0,0);e.addColorStop(0,"rgba(0,0,0,1)"),e.addColorStop(.1,"rgba(0,0,0,0.9)"),e.addColorStop(.2,"rgba(0,0,0,0.8)"),e.addColorStop(.3,"rgba(0,0,0,0.7)"),e.addColorStop(.4,"rgba(0,0,0,0.6)"),e.addColorStop(.5,"rgba(0,0,0,0.5)"),e.addColorStop(.6,"rgba(0,0,0,0.4)"),e.addColorStop(.7,"rgba(0,0,0,0.3)"),e.addColorStop(.8,"rgba(0,0,0,0.2)"),e.addColorStop(.9,"rgba(0,0,0,0.1)"),e.addColorStop(1,"rgba(0,0,0,0)"),t.globalCompositeOperation="source-in",t.fillStyle=e,t.fill(),t.restore();// // Hacky
// ctx.save();
// ctx.translate(this.startPos.x, this.startPos.y);
// ctx.rotate(this.getDegrees(this.startPos, this.aimPos) + Math.PI / 2);
// ctx.beginPath();
// ctx.arc(0, 25, 25, 0, Math.PI * 2);
// ctx.clip();
// ctx.globalCompositeOperation = "source-in";
// ctx.fillStyle = "transparent";
// ctx.fill();
// ctx.restore();
}getDegrees(t,e){if(e.y>t.y){if(e.x>t.x){let s=Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))+Math.PI/2;return s}}if(e.x>t.x){let s=-Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x));return s}{let s=-Math.atan(Math.abs(e.x-t.x)/Math.abs(e.y-t.y))-Math.PI/2;return s}}}class G{constructor(t,e,s){this.structure=t,this.game=s,this.playerSystem=new S,this.moveSystem=new g,this.collisionSystem=new y,this.lightsourceSystem=new F,this.shootSystem=new v,this.sightSystem=new O(this.game.gameWidth,this.game.gameHeight),this.playerTurnSystem=new R,this.entities=[],this.offsetX=0,this.offsetY=0,this.levelState="PLAYER_1_TURN",this.playerTurnTimer=5,this.playerTurnCount=0,this.player1Turn=[],this.player2Turn=[],this.playerTurnCurrentIndex=0,this.texture=null;let i=new Image;i.src=e,this.texture=i}buildLevel(t,e){let s=[],i=this.structure[0].length,n=this.structure.length;for(let t of this.structure)if(t.length!==i)throw Error("Not all rows in level structure have the same size");let o=0;if(t/e<i/n?(o=t/i,this.offsetX=0,this.offsetY=(e-o*n)/2):(o=e/n,this.offsetX=(t-o*i)/2,this.offsetY=0),o<=0)throw Error("Cell size less than 0");for(let t=0;t<this.structure.length;t++)for(let e=0;e<this.structure[t].length;e++){let i={x:e,y:t};switch(s.push(new I({x:o*i.x+this.offsetX,y:o*i.y+this.offsetY},{width:o,height:o})),this.structure[t][e]){case 1:{let t=new k({x:o*i.x+this.offsetX,y:o*i.y+this.offsetY},{width:o,height:o});t.addComponents(new p),s.push(t);break}case 2:if("PLAYER_1_TURN"===this.levelState||"RESULT"===this.levelState){let t=new m({x:o*i.x+this.offsetX,y:o*i.y+this.offsetY},{width:o,height:o});t.addComponents(new u,new E),s.push(t)}break;case 3:if("PLAYER_2_TURN"===this.levelState||"RESULT"===this.levelState){let t=new w({x:o*i.x+this.offsetX,y:o*i.y+this.offsetY},{width:o,height:o});t.addComponents(new u,new E),s.push(t)}}}this.entities=s}update(t,e){if("RESULT"===this.levelState){for(let s of[this.playerSystem,this.moveSystem,this.collisionSystem,this.shootSystem,this.sightSystem,this.playerTurnSystem]){let i=this.entities.filter(s.appliesTo);s.update(i,t,this,e)}this.playerTurnCurrentIndex++}else for(let s of[this.playerSystem,this.moveSystem,this.collisionSystem,this.lightsourceSystem,this.shootSystem,this.sightSystem,this.playerTurnSystem]){let i=this.entities.filter(s.appliesTo);s.update(i,t,this,e)}}draw(t,e,s){for(let e of(this.texture&&t.drawImage(this.texture,0,0,this.game.gameWidth,this.game.gameHeight),this.entities))e.draw(t);for(let e of[this.shootSystem])e.draw(t);("PLAYER_1_TURN"===this.levelState||"PLAYER_2_TURN"===this.levelState)&&"RUNNING"===this.game.gameState&&(this.lightsourceSystem.draw(e),this.sightSystem.draw(s))}}var j={};j=new URL(o("dRo73").resolve("kU9W7"),import.meta.url).toString();class K extends G{constructor(t){super([[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1],[1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],/*@__PURE__*/e(j),t)}}const V=document.querySelector("#gameScreen"),Z=V.getContext("2d");Z.imageSmoothingEnabled=!0,Z.imageSmoothingQuality="high";const J=document.querySelector("#shadowCanvas"),Q=J.getContext("2d"),B=document.querySelector("#sightCanvas"),$=B.getContext("2d"),tt=window.innerWidth,te=window.innerHeight;V.width=tt,V.height=te,J.width=tt,J.height=te,B.width=tt,B.height=te;const ts=new class{constructor(t,e,s,i,n,o={x:t/2,y:e/2}){this.gameWidth=t,this.gameHeight=e,this.mainCtx=s,this.shadowCtx=i,this.sightCtx=n,this.mousePos=o,this.level=new K(this),this.entities=[],this.keys=new Set,this.gameState="PAUSED",this.gameStartCountDown=3,document.querySelector("#gameScreen").addEventListener("click",t=>{this.keys.add("leftClick")}),document.querySelector("#gameScreen").addEventListener("mousemove",t=>{this.mousePos={x:t.offsetX,y:t.offsetY}}),this.start()}start(){this.level.buildLevel(this.gameWidth,this.gameHeight)}update(t){"RUNNING"===this.gameState&&this.level.update(t,this),"PAUSED"===this.gameState&&this.gameStartCountDown>0&&(this.gameStartCountDown-=t),this.gameStartCountDown<=0&&(this.gameState="RUNNING"),this.keys.delete("leftClick")}draw(t,e,s){this.level.draw(t,e,s),"PAUSED"===this.gameState&&(t.save(),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,this.gameWidth,this.gameHeight),t.font="30px Arial",t.fillStyle="white",t.textAlign="center",this.gameStartCountDown<=1?t.fillText("1",this.gameWidth/2,this.gameHeight/2):this.gameStartCountDown<=2?t.fillText("2",this.gameWidth/2,this.gameHeight/2):this.gameStartCountDown<=3&&t.fillText("3",this.gameWidth/2,this.gameHeight/2),t.restore())}}(tt,te,Z,Q,$);let ti=0;requestAnimationFrame(function t(e){// dt i sekunder
let s=(e-ti)/1e3;ti=e,Z.clearRect(0,0,tt,te),Q.clearRect(0,0,tt,te),$.clearRect(0,0,tt,te),ts.update(s),ts.draw(Z,Q,$),requestAnimationFrame(t)});